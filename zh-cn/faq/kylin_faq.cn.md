# Apache Kylin常见问题

以下收集了用户在学习使用Apache Kylin过程中经常遇到的一些问题，大部分原理类问题也适用于KAP。

### 原理类

**Q：Kylin的核心思想空间换时间是怎么工作的，如何做到大数据O(1)的查询复杂度？**

**Q：Kylin需要很多的存储空间吗？如何预估Kylin空间膨胀率？**

**Q：Kylin的Cube结果保存在哪里？查询时是访问内存还是哪里？**

**Q：多表关联查询是预先对所有的表打cube，然后关联cube查询吗？**

**Q：如果一张表被用在多个Cube中，查询时会查询哪个Cube呢？正确性会受到影响吗？**

**Q：Kylin能用Spark引擎吗？为什么说Kylin的算法在Spark下效率和MR差不多？**

**Q：Kylin做ETL吗？**

**Q：Kylin可以实时构建Cube吗？**

**Q：如果缺少建模的维度，用户查询时结果会怎样？**

**Q：Kylin是否支持增量构建？ **

**Q：Kylin支持明细数据查询吗？ **

**Q：Kylin高级功能还开源吗？**

### 设计类

**Q: Kylin最大能支持的维度有多少？**

A: 这个问题不是简单一个数字能回答的；首先，Kyin的多维立方体“物理”维度最多64个，但用户可以通过使用维表+定义"衍生"（Derived）维度的方式，将一个维度衍生出更多维，从而达到支持上百个维度查询的Cube。通常建议Cube的物理维度（除去衍生唯度）在15个以内，当有更多维度的时候，务必分析用户查询模式和数据分布特征，采取维度分组，定义mandantory、hierarchy和joint等高级手段，避免维度间的肆意组合（“维度的灾难”），从而使得Cube的构建时间和所占空间在可控范围。


**Q: 维度可以动态增加吗？减少呢？**

A: 当增减维度时，Cube需要重新计算；如果不想重新计算历史Cube，可以定义新Cube，然后将新老Cube做一个组合（Hybrid），一起响应用户查询。

**Q: Kylin构建Cube的过程要多久？有时很慢，如何优化？**

A: 通常Cube构建在几十分钟到几小时，取决于数据量、模型复杂度、维度基数、集群计算能力和配置等多方面。优化需要具体问题具体分析。

**Q: 构建Cube时，经常OOM，如何调整？可以关掉InMem模式吗？**

A：OOM需要看具体在哪一步发生，采取不同措施；如果是在“Build Dictionary”发生，需要审视Cube定义，看是否有对超高基数维度使用了字典编码（可改用其它编码方式）；如果是在"Build Cube"时候发生，需要检查Yarn的内存分配设置；要关闭InMem模式，可以在conf/kylin.properties里设置kylin.cube.algorithm=layer

**Q: 维度超过10个时，构建过程跑不起来，如何优化？**

A：参见第一个问题的回答

**Q: 如果有多张事实表，该如何使用Kylin？**

A: 可以为每个事实表定义一个Cube，然后使用sub query来组合这几张表的查询。或者使用Hive view将多张事实表join成一张宽表，然后用这张宽表定义模型和Cube，查询按宽表进行。

**Q: Segment的数量影响查询的性能吗？大的Segment可以拆分成小的吗？**

A：Segment的数量会影响查询性能，因为Kylin需要顺序扫描每个Segment，所以通常建议定期进行Segment合并；大的Segment无需拆分成小的（也拆分不了）；在存储到HBase时会切分成多个region，所以不用担心查询性能。

**Q: 源数据模型变化了怎么办？**

A：具体问题具体分析；增加字段是没有问题的，删除或修改字段可能会导致metadata混乱。所以建议不要修改原始数据模型；如果无法避免，建议在源模型上创建Hive view，然后基于view来定义Cube；当源模型改变时（如列名更改），只需更新view即可，Cube不受影响。

**Q: 关系型数据库如何使用Kylin？**

A：使用工具(如sqoop)先将数据从RDBMS导入到Hive

**Q: Kylin会支持雪花模型吗？**

A: 未来版本将会支持

### 整合类

**Q：Kylin可以和Pentaho整合吗？**

A： 可以，背后olap引擎是基于mondrian，saiku也是同理。

**Q：使用Kylin还需要BI系统吗？**

A：Kylin本身的核心在于强大的后端，针对数据分析提供亚秒级的响应。同时对外部各个BI平台也有很好的集成，也提供了丰富的API供进行二次开发。所以针对Apache Kylin需要配合其他的BI系统一起使用。

KAP已经内置了敏捷BI平台KyAnalyzer，不再需要另外开发或购买BI产品。

**Q：Kylin如何和Mondrain整合呢？**

A：需要对Mondrian进行二次开发，网上已经有很多分享，很简单。具体内容搜一下。

### 对比类

**Q：Kylin与Spark、Impala有什么区别？**

A：从业内的使用经验来看，目前Hadoop平台上可用于查询分析的几种技术主要包括预计算（Kylin）、内存计算（以Spark为代表）、倒排索引（以ElasticSearche为代表）和列式存储（以Impala为代表）。

从技术原理来看，预计算技术将数据事先按维度组合聚合，保存结果为物化视图。经过聚合，物化视图的规模将只由维度的基数决定，而不再随数据量的增长而线性增长。以电商为例，如果业务扩张，交易量增长了10倍，但只要交易数据的维度不变（供应商/商品数量不变），聚合后的物化视图将依旧是原先的大小。查询的速度也将保持不变，即计算时间复杂度相对数据量是O(1)的。

而内存计算、倒排索引、列式存储等技术，虽然其技术原理各不相同，但都是在查询执行时（runtime）对明细数据进行在线的汇总统计，因此这些技术在数据记录数较少时（百万~千万），性能还处于可接受范围。但随着数据量快速增长（硬件资源不增加），其查询速度也将随着数据量的增长而线性增长，因此其计算时间复杂度相对数据量为O(N)的。

各种技术的计算时间复杂度对比如下图所示。从大数据背景来看，网络日志、系统日志、物联网等各种数据在飞速而持续的产生着，从而对于大数据查询分析来说，其面对的数据量将是一个爆发式的增长模式，因此，预计算这种能够屏蔽数据量爆发增长带来的计算压力，保持计算时间复杂度O(1)的技术将是最理想也是最合适的技术。而Apache Kylin，是目前Hadoop生态系统里唯一采用预计算这种技术的查询分析引擎，开源之后迅速成为Apache开源社区的顶级项目，并且在全球众多大型互联网、电信、金融企业里得到了广泛应用。

![复杂度](images/complexity.png)

### 其它

**Q：Kylin可以跑TPCH吗？**

A: 我们提供了针对Kylin的测试数据生成工具SSB，此数据集的模型为根据TPCH简化而成的星形模型。理论上Kylin可以跑TPCH，但是需要对TPCH的模型进行调整，使其成为星形模型。更新信息请参考：[https://github.com/kyligence/ssb-kylin](https://github.com/kyligence/ssb-kylin)

